.. _FS_08_GroupAnalysis:

======================================
FreeSurfer Tutorial #8: Group Analysis
======================================

---------------

Overview
*********

The previous tutorials have focused on preparing the data for a group analysis: First, the data was preprocessed through recon-all, with different structural measurements calculated at each vertex; and second, we created an FSGD file and a contrast file indicating which groups we want to compare against each other.

If you recall from a previous tutorial, I recommended using the ``qcache`` option when running recon-all. This will generate thickness, volume, and curvature maps at several different smoothing sizes, such as 0mm, 10mm, and 25mm full-width half-maximum kernels. One of the benefits of surface-based analysis is that you can use much larger smoothing kernels than in volumetric-based analyses, because there is no risk of smoothing across gyri. When you run the group analysis you can choose among any of these smoothing sizes for your analysis.


.. figure:: 08_Qcache_Output.png
  
  Example output from qcache. Notice how the thickness estimates across the subjects become smoother as a result of using large smoothing kernels.


.. warning::

  Before looking at your group analyses, decide on which smoothing kernel you will use - and then stick to it. This will prevent you from checking every possible smoothing size, which in turn will require you to correct for the number of tests that you examine with different smoothing kernels.


mris_preproc
************

In order to run a group analysis, we will need to combine all of our individual structural maps into a single dataset. This is a similar idea to combining consecutive volumes of an fMRI run into a one dataset, as though the volumes are daisy-chained together and laid end to end. (Or, to think of it another way, the structural images are stacked on top of each other, like pancakes; or layered like nachos. Use whatever food analogy is most helpful to remember this important point.) 

.. figure:: 08_mrispreproc_Concatenation.gif

The data are also **resampled** to the fsaverage template, which is in MNI space. Whenever we do any kind of group analysis - comparing groups, region of interest analysis, and so on - each subject's data must have the same dimensions and voxel resolution. Forgetting to resample usually leads to errors during this step. (All of this applies to fMRI analysis as well.)

We will perform all of these steps with a single command: **mris_preproc**. The command requires the following arguments:

1. An FSGD file (which we created in the previous tutorial);
2. A template to resample to;
3. An indication of which hemisphere to resample;
4. A label for the output file.

In this tutorial, we will also use the ``--cache-in`` option to specify which smoothed images we want to use in the analysis. You can choose any of the smoothed images generated by using the ``--qcache`` option with recon-all.

To make the command more compact, to and more it adaptable to any study you wish to analyze, we will use the following code:

::

  #!/bin/tcsh
  
  setenv study $argv[1]
  
  foreach hemi (lh rh)
    foreach smoothing (10)
      foreach meas (volume thickness)
        mris_preproc --fsge FSGD/{$study}.fsgd \
          --cache-in {$meas}.fwhm{$smoothing}.fsaverage \
          --target fsaverage \
          --hemi {$hemi} \
          --out {$hemi}.{$meas}.{$study}.{$smoothing}.mgh
      end
    end
  end
  

  
  


  
